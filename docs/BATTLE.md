# ZERO R｜战士·斗气体系 × 伤害结算

## 0. 概念与符号

* **境界 Realm**：一级→六级（无小境界），七级→九级（四小阶），圣域（四小阶+极限）。小境界：初/中/高/巅（圣域加“极限”）。
* **修炼进度 Progress**：每小境界 0–100%，满即**瓶颈**。
* **斗气本源 Base Power, BP**：隐藏绝对值，是一切斗气转化的“根”。
* **身体属性 Body**：`HP, QiMax, ATK, DEF, AGI, REC`（仅 Body 分支承载 HP 上限与生命相关改造/功法生命加成）。
* **斗气属性 Qi_***：由功法把 BP 按侧重转为 `Qi_ATK / Qi_DEF / Qi_AGI`（仅在**运转**时参与面板，且受**预热 F(t)** 缩放）。
* **运转预热**：`F(t) = clamp(t/30s, 0, 1)`；退出或未满时，所有**来自 Qi 的加成/判定**按 F(t) 生效。
* **斗气值 Qi**：战斗资源；`Qi ∈ [0, QiMax]`。
* **tough（韧性系数）**：参与减伤的环境系数。玩家=**1.0**；怪物=**1.0**；BOSS=**1.5**。
* **随机与取整口径（新增）**：`roll ~ U[0.8,1.2]`（均匀）；对外可见数值**四舍五入**，内部累计保留小数到帧末再取整。
---

## 1. 境界与 BP 区间（映射沿用）

为每个（小）境界定义 BP 区间 [BP_min, BP_max]。进度 p（0–1）线性映射到区间：

```
BP_current = BP_min + (BP_max - BP_min) * p
```

**推荐区间（示例，指数式平滑递增）：**

| 大境界 | 小境界        | BP区间（含起止）                               | 备注                       |
| --- | ---------- | --------------------------------------- | ------------------------ |
| 一级  | —          | 100–200                                 |                          |
| 二级  | —          | 200–400                                 |                          |
| 三级  | —          | 400–800                                 |                          |
| 四级  | —          | 800–1,600                               |                          |
| 五级  | —          | 1,600–3,200                             |                          |
| 六级  | —          | 3,200–6,400                             |                          |
| 七级  | 初/中/高/巅    | 6,400–12,800（**每段+1,600**）              |                          |
| 八级  | 初/中/高/巅    | 12,800–25,600（**每段+3,200**）             |                          |
| 九级  | 初/中/高/巅    | 25,600–51,200（**每段+6,400**）             |                          |
| 圣域  | 初/中/高/巅/极限 | 51,200–102,400（前四段均分，**极限=区间顶+20%潜力池**） | 极限潜力池只触发部分被动，不线性推高 QiMax |

---

## 2. 属性与功法

### 2.1 身体属性（地基）

```
Body = { HP, QiMax, ATK, DEF, AGI, REC }
```

* **大境界突破**：两段式强化（逐项），**顺序：先乘后加**
  `Body_attr *= (1 + R_realm_attr)` 与 `Body_attr += D_realm_attr`

  **每提升 1 个“大境界”的建议数值**（圣域每一小境界按该档的 25% 计；极限不额外乘加，仅触发被动）：

  | 属性    | R_realm_attr | D_realm_attr |
  | ----- | -----------: | -----------: |
  | HP    |         +20% |          +80 |
  | QiMax |         +15% |           +0 |
  | ATK   |          +8% |           +4 |
  | DEF   |          +8% |           +4 |
  | AGI   |          +8% |           +2 |
  | REC   |         +10% |           +2 |

* **功法生命加成**：仍只修饰 **Body_HP 分支**（不计入 Qi 派生）。

* **天材地宝**：保留为离散加成；幅度锚点：小型(+5 HP/+1 ATK/DEF/REC 或 +1~2%HP)、中型(+20/+3 或 +3~5%HP)、大型(+80/+8 或 +8~12%HP)。

* **QiMax 与 BP（数值确定）**：
  `QiMax = A * BP_current`，**A = 0.5**。

### 2.2 斗气属性（三维）

将 BP 转换为可分配单位并按功法侧重自动分配：

```
unit   = BP_current / K_bp2unit      # K_bp2unit = 10
Qi_ATK = unit * coef_ATK
Qi_DEF = unit * coef_DEF
Qi_AGI = unit * coef_AGI
```

**功法侧重（合计=1.0；紫焰保留恢复系 0.25，不计入三维）**：

* 龙血：均衡（0.40 / 0.40 / 0.20）
* 不死：攻防（0.45 / 0.50 / 0.05）
* 虎纹：敏攻（0.50 / 0.10 / 0.40）
* **紫焰**：三维（0.30 / 0.30 / 0.15 = 0.75） + **恢复系 0.25（见 §4）**

> **凡 Qi 派生的量，在计算前都乘以 `F(t)`**（含 ATK/DEF/AGI 的 Qi 部分、斗气防御吸收强度、恢复效率放大等）。

### 2.3 最终面板（仅三项 + 资源）

```
ATK_final = Body_ATK + F(t) * Qi_ATK
DEF_final = Body_DEF + F(t) * Qi_DEF
AGI_final = Body_AGI + F(t) * Qi_AGI
HP_max    = Body_HP（含功法生命加成与道具）
QiMax     = 0.5 * BP_current
REC_final = Body_REC * (1 + R_passives)   # 试运行默认 R_passives=0
```

---

## 3. 修炼、瓶颈与突破

### 3.1 BP 增长（公式闭环）

```
ΔBP = K_bp * { K_env * (α * Qi_spent + β * Qi_restored) + K_actions }
```

* **K_bp=1e-5；α=1.0；β=0.5**（**紫焰**：β→`β_zy=0.6`）
* **K_env（场景）**：普通战斗=1.0；Boss=1.2；训练木桩=0.8；野外闲逛=0.4；城内休整=0.3；冥想=0.2；**战后余劲15min=×1.5（乘在 K_env 上）**
* **K_actions（事件等价量）**：普攻命中=150；受击=300；完美闪避=800；终结技命中=1200；重伤坚持(HP≤20%，每秒)=200

  * 境界自适应：`S_realm = clamp(BP_min_current / BP_current, 0.25, 1.0)`；`K_actions ← S_realm * K_actions`
* 小境界满（100%）后不再涨，进入**突破判定池**。

### 3.2 突破方式

1. **强行突破**

   * 代价：清空当前斗气（不影响上限）
   * 成功率：

     * 基础 `P0(p) = 0.08 - 0.04*p`（p∈[0,1]）
     * 瓶颈后“超额修炼余量 e”：`f_e = 1 + 0.5 * clamp(e/e_cap, 0, 1)`
     * 道具/祝福：乘法合并（如 ×1.20、×1.10）
     * **最终** `P = P0 * f_e * buffs`，**单次上限 35%**

2. **生死战斗**（战斗中“应增进度”的时刻改为判定；**内冷却 0.5s**）

   ```
   P = 0.03 * m_hp * m_chain * m_gap      # cap 25%/次
   m_hp   = 1 + 2*clamp((0.20 - HP_ratio)/0.20, 0, 1)   # HP≤20% → ×3
   m_chain= 1 + 0.05 * hits_6s            # 6s内连续受创，每次+5%，上限×1.5
   m_gap  = 1 + 0.5 * clamp((QiMax - Qi)/QiMax, 0, 1)   # 最大×1.5
   ```

3. **天材地宝**

   * 触发：消耗特定道具
   * 效果：直接判定突破（高概率或必成，视稀有度）

4. **高人指点**：**×1.15（乘法）**，限时 30min 或成功一次即失效。

> 成功：境界提升到下一段，小境界重置为0%并进入新 BP 区间起点，按 §2.1 对身体属性执行一轮“基础改造；失败：保持瓶颈状态（强突失败则斗气清零）。

---

## 4. 斗气资源系统

### 4.1 运转状态与预热

* 开启运转：进入预热，30s 达满：`F(t)=clamp(t/30,0,1)`
* 维持：无额外维持费，但动作会消耗 Qi
* 退出：动作后 `Qi < 5% * QiMax` → 自动退出；重开需重新预热（**无余温保留**，首版简化）

### 4.2 消耗、恢复与被动

* **动作消耗（按 QiMax 百分比）**

  * 普攻/小/中/大技能 → `q1/q2/q3/q4 = 1% / 3% / 7% / 12% * QiMax`
  * 斗气闪避：`1% * QiMax`
  * 斗气防御蓝耗：见 §4.3（`qi_cost = absorbed * w`，w=1.1）
* **自然恢复（Qi/秒）**

  ```
  Qi_recover_per_sec = (r0 + r1*REC_final) * state_mult * F_mult
  r0 = 1.0,  r1 = 0.06
  state_mult: 运转=1.0；非运转=1.5；冥想=3.0
  F_mult: 运转中=F(t)；非运转/冥想=1.0
  ```

  * **紫焰·恢复被动**：

    * `REC_final += 20`（Body 分支直加，不受 F(t)）
    * 在 `ΔBP` 中恢复项权重：`β_zy = 0.6`
    * 恢复效率额外放大：`Qi_recover_per_sec *= (1 + 0.2 * F(t))`
    * 圣域极限：+10 REC 与冥想效率 +5%（累乘）
* **HP自然恢复**：`HP_recover_per_sec = 0.1 * REC_final`；战斗中×0.5，Boss 场×0.25

### 4.3 斗气防御（固定 90% × 预热；加上单次上限）

```
absorb_ratio_eff = 0.90 * F(t)
qi_cost = absorbed_damage * w             # w=1.1
absorbed_per_hit ≤ 0.60 * incoming        # 单次上限
```

* 可用性：仅运转中；一次结算后若 `Qi < 5%*QiMax` → 退出运转。
* **结算顺序明确**：穿透与减伤→得到 `dmg` → 斗气防御吸收 → HP 扣除；**被吸收的部分不再二次穿透**。

### 4.4 斗气闪避（主动帧技）

```
P_dodge = clamp(P0 + k*(AGI_final - AGI_enemy_final), 0, 1.0)
P0=0.10, k=0.002
窗口=0.2s，冷却=0.7s，消耗=1%QiMax，成功返还=0.5%QiMax
```

---

## 5. 与境界相关的对抗参数

### 5.1 参考防御 `DEF_ref(realm_stage)`

* 大境界起点：
  `60, 120, 240, 480, 960, 1920, 3840, 7680, 15360, 30720`
* 小境界线性插值示例（固定表）：

|  段 |    七级 |     八级 |     九级 | 圣域(前四) |
| -: | ----: | -----: | -----: | -----: |
|  初 | 3,840 |  7,680 | 15,360 | 30,720 |
|  中 | 4,800 | 10,240 | 21,760 | 40,960 |
|  高 | 5,760 | 12,800 | 28,160 | 51,200 |
|  巅 | 6,720 | 15,360 | 34,560 | 61,440 |

> 圣域极限：沿用“巅”值（不额外提高 DEF_ref）。

### 5.2 穿透 `PenPct(realm_attacker, rank)`（怪物/敌方）

```
PenPct = clamp( 0.05 + 0.01*Realm_attacker + 0.03*rank , 0, 0.60 )
```

* 示例：七级精英=0.05+0.07+0.03=**0.15**；九级BOSS=0.05+0.09+0.06=**0.20**
* **PenFlat**：默认 0（由技能/装备赋予）。典型范围：+20（早期）~+400（后期），爆发/破甲类短时可达 +800。
* 玩家作为攻方默认 `PenPct=0, PenFlat=0`（由技能/装备决定）。

---

## 6. 伤害结算管线

### 6.1 命中前闪避检查

* 若在 0.2s 窗口内，且闪避判定成功 → **直接免伤**；失败 → 进入伤害管线。

### 6.2 物理主干

```
raw     = ATK_final × skill.mult × roll(0.8~1.2)

effDEF  = max(0, DEF_final - PenFlat) × (1 - PenPct) × tough_target
# tough_target：玩家=1.0；怪物=1.0；BOSS=1.5（地图/词缀可在 0.5~2.0 内微调）

# 期望减伤曲线（f 为目标减伤在 50% 时的平衡点）
f       = 0.50
K       = (f/(1-f)) × DEF_ref(realm_stage_target)   # = 1 × DEF_ref
mitig   = K / (K + effDEF)

dmg     = round(raw × mitig)
```

**技能倍率档（统一）**：普攻 1.0 / 小 1.6 / 中 2.4 / 大 3.6 / 终招 6.0

### 6.3 斗气层（防御）

```
incoming = dmg
if is_qi_running() and F(t)>0 and incoming>0:
    ratio_eff   = 0.90 * F(t)
    absorbed_cap= 0.60 * incoming
    absorbed    = min(incoming * ratio_eff, absorbed_cap)
    qi_need     = absorbed * 1.1
    if Qi >= qi_need:
        Qi  -= qi_need
        incoming -= absorbed
    else:
        can_absorb = Qi / 1.1
        Qi = 0
        incoming -= can_absorb
        if Qi < 0.05 * QiMax:
            exit_run_state()

HP -= round(max(0, incoming))
```

---

## 7. UI 与可视化

* **境界条**：显示当前段与小境界进度；满值时高亮“瓶颈”，列出可用突破途径与成功率修正（本版概率如 §3.2）。
* **斗气状态环**：显示 `Qi/QiMax`、运转状态、`F(t)` 预热进度、低蓝警示（<5%）。
* **面板区**：

  * **身体属性**：HP/QiMax/ATK/DEF/AGI/REC（功法生命加成体现在 HP）。
  * **斗气加成（运转）**：实时显示 `F(t)*Qi_ATK/DEF/AGI` 的**当前有效值**（括号内可展示理论值以供对比）。
* **成长提示**：战后余劲、突破率增益、`ΔBP` 的小提示“+”。

---

## 8. 调参起点（统一）

* **BP→单位**：`K_bp2unit = 10`
* **修炼**：`α=1.0, β=0.5（紫焰=0.6）；K_bp=1e-5；K_env：战斗1.0/Boss1.2/木桩0.8/野外0.4/城内0.3/冥想0.2；战后余劲(15min)=×1.5；K_actions：普攻150/受击300/完美闪避800/终招1200/重伤坚持200`
* **突破**：强突基础 `P0(p)=0.08-0.04p`（至 4%），超额修炼加成 `f_e`，单次 cap 35%；生死战基础 3%，`HP≤20%` → ×3，6s 连受创加成（每次+5%，至×1.5），斗气缺口加成至×1.5，**单次 cap 25%**；导师指点 **×1.15（乘法）**。
* **运转**：预热 30s；退出阈值 `5% QiMax`；**消耗** q1/3/7/12% QiMax；闪避 1% QiMax（成功返 0.5%）；非运转恢复=×1.5；冥想=×3。
* **恢复**：`Qi_recover_per_sec = (1 + 0.06*REC_final) × state_mult × F_mult`（运转中乘 F(t)）；紫焰额外 ×`(1+0.2F)` 与 `REC+20`、ΔBP 恢复权重=0.6。
* **防御**：斗气防御固定 90%（有效吸收受 `F(t)`），**单次吸收不超过来伤的 60%**；`w=1.1`。
* **对抗**：`PenPct = clamp(0.05 + 0.01*Realm + 0.03*rank, 0, 0.60)`；`PenFlat` 由技能/装备给（+20~+400，爆发+800）。
* **减伤曲线**：`f=0.5`，`K = DEF_ref`；tough：玩家1.0/怪物1.0/BOSS1.5，地图/词缀浮动范围 0.5~2.0。

# ZERO R 战斗与属性系统迁移计划

## 更新记录（Step 1）

- 完成数据模型重构：`src/types/domain.ts` 承载境界/BP、Body & Qi 属性、斗气运转/恢复状态等核心结构。
- 更新初始化与存档逻辑：`useLeveling` 与 `player` store 生成/融合新数据结构，维持旧字段向后兼容的同时引入 Qi 资源流。
- 战斗与技能基础适配：`battle` store 追踪玩家斗气、支持 Qi 消耗/回复；技能数据改用 `stats.totals` 与怪物归一化防御、韧性、等级。
- UI 侧初步展示：状态面板新增 Qi 条、敏捷/恢复面板并支持 Qi 药剂描述，背包可见新增副属性列。
- ⚙️ 完成斗气循环一步走通：重写 `useLeveling`/`player`/`battle` 之间的预热 F(t)、自然恢复、ΔBP 累积与战斗动作权重；技能与消耗品全面转为 Qi 体系并清理等级/EXP 依赖。

## 下一步重点

1. 打通战斗产出的 ΔBP 与战后结算（已完成）：统一 `Monster.rewards.deltaBp` 接口并在胜利结算时应用；掉落维持原表；战斗 UI 加入 ΔBP 增量与“储能溢出/瓶颈”提示。
2. 完善 `useDamage` 与相关调用（部分完成）：已接入境界基准防御/穿透与玩家受击侧斗气防御；待补闪避判定、怪物侧斗气防御与怪物属性迁移至新模型。
3. 扩展 UI 与调试（部分完成）：状态面板展示 F(t) 进度与运转切换、战斗浮动文本展示 ΔBP；待加调试入口（环境系数/动作权重）与更完整战斗可视化。
4. 依据新模型建立自动化校验（数值回归脚本或单测），覆盖成长曲线、资源循环、战斗公式。

## 1. 实施范围

- 将现有等级、属性、战斗实现从 `docs/DESIGN.md` 迁移到 `docs/BATTLE.md` 描述的境界与斗气体系，保留装备、掉落等非战斗模块做后续适配。

## 2. 数据模型与存档

- ✅ 在 `src/types/domain.ts` 扩展核心类型：新增境界、小境界、BP、功法、Body/Qi 属性、运转状态、预热进度、斗气资源条等字段，重构 `Stats`、`Resources`，区分 Body 与 Qi 派生并加入 `Qi` 和 `REC`。
- ✅ 重建玩家 `Player`、怪物 `Monster` 结构以支持新字段（境界、熟练度、穿透、韧性等），并定义突破记录、预热计时、熟练度接口。
- ⚠️ 历史存档不考虑迁移或者兼容。

## 3. 成长体系与资源循环

- ✅ 重写 `src/composables/useLeveling.ts`：完成 BP 区间映射、境界乘加强化、`F(t)` 预热曲线、环境系数与自然恢复公式。
- ✅ 在 `src/stores/player.ts` 重算最终面板：区分 Body/Qi，提供 Qi 耗还接口并在耗尽时自动退出运转，接入预热缩放与自然恢复；整合功法系数与紫焰被动。
- ✅ 实现 ΔBP 积累与瓶颈判定；新增突破接口：计算成功率、记录尝试、冷却与溢出消耗，并在数据层接入（`useLeveling.attemptBreakthrough`）。UI/道具对接与持久化冷却展示留待 UI 阶段。

## 4. 战斗循环与数值公式

- ✅ 重写 `src/composables/useDamage.ts`：接入境界 `DEF_ref` 表、穿透、减伤曲线，统一倍率（普1.0/小1.6/终6.0），按 BATTLE.md 取整与随机口径。
- ✅ `src/stores/battle.ts` 接入斗气防御（玩家受击侧，F(t)×90%，单次≤60%，w=1.1，低蓝自动退运转由 `spendQi` 托管）；技能侧已走新伤害管线与 DEF_ref（怪物缺少 realm 时回退旧拟合）。
  - 🔄 闪避前置判定与怪物侧斗气防御：尚未实现，计划与命中/暴击一并前置。

## 5. 技能、道具、怪物配置

- 🔄 `src/data/skills.ts` 已改用新 `SkillContext`，已实现 Qi 百分比消耗与部分斗气收益；仍缺熟练度调整与更多技能覆盖。
- 🔄 `src/data/items.ts`/快捷栏组件已支持 Qi 回复显示与战斗内冷却圈，但仍缺突破类道具。
- ⏳ 扩展 `src/data/monsters.ts`：待补充境界段、rank、AGI、穿透等数据并按 `DEF_ref` 曲线重算。

## 6. UI 与交互

- 🔄 `src/components/PlayerStatusPanel.vue` 已加入 Qi 条、敏捷/恢复展示；仍需境界进度、运转状态、突破交互等。
- 🔄 `src/views/BattleView.vue` 已新增怪物攻击倒计时条与提示光环；仍待呈现 Qi 防御、闪避冷却、F(t) 更细节可视化。
- ⏳ 浮动文本/闪光效果需扩展以覆盖突破、斗气吸收、闪避成功等事件。

## 7. 验证与迁移

- 编写测试或调试脚本验证关键公式：预热曲线、动作消耗/恢复、伤害、突破概率；定位到 `tests/` 或 `src/__tests__/`。
- 准备调试工具或面板验证境界跳跃、资源循环、战斗流程，检查自动重赛、退出战斗、换装兼容性。
- 更新文档引用（例如 README 或游戏内帮助）指向 `docs/BATTLE.md`，并撰写迁移说明。

## 8. 执行顺序建议

1. 先完成数据模型。
2. 逐步上线资源与战斗公式，配合调试工具校准数值。
3. 最后处理 UI/交互与测试，统一验证流程是否符合 `docs/BATTLE.md`。

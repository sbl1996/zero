# 地图编辑器

## 概述

基于游戏真实渲染方式的地图编辑器，支持可视化编辑地图节点、连接关系和怪物生成配置。提供完整的撤销/重做功能，实时保存状态追踪。

## 功能特性

### 后端 (Python/FastAPI)

**API 端点:**
- `GET /api/maps` - 获取所有地图列表
- `GET /api/maps/{map_id}` - 获取单个地图详情
- `POST /api/maps` - 创建新地图
- `PUT /api/maps/{map_id}` - 更新地图
- `DELETE /api/maps/{map_id}` - 删除地图
- `GET /api/maps/{map_id}/image` - 获取地图背景图

**数据模型:**
- `MapMetadata` - 地图元数据（包含名称、类别、背景图、BGM 等）
- `MapNode` - 野外地图节点（战斗点/传送门）
- `MapLocation` - 城市地图地点（可交互位置）
- `SpawnConfig` - 怪物生成配置（数量、刷新间隔、怪物列表）
- `Destination` - 传送门目标（跨地图传送）

### 前端 (Vue 3 + TypeScript)

**核心组件:**

1. **MapEditor.vue** - 主编辑器
   - 整合所有子组件
   - 管理编辑状态（选择、移动、连接、添加）
   - 处理保存/加载逻辑
   - 撤销/重做功能
   - 快捷键支持（Ctrl+Z, Ctrl+Y）

2. **MapList.vue** - 地图列表
   - 按城市/野外分组显示
   - 切换当前编辑地图

3. **MapCanvas.vue** - 可视化画布 ⭐
   - 完全复用游戏渲染样式 (`MapView.vue`)
   - 百分比坐标系统（0-100）
   - SVG 连接线绘制（可交互）
   - 节点拖拽编辑（实时更新）
   - 网格系统和吸附功能
   - 多种编辑模式：
     * **选择模式**: 点击选中节点/地点
     * **移动模式**: 拖拽移动位置
     * **连接模式**: 建立节点连接
     * **添加模式**: 创建新节点/地点
   - 缩放控制（50%-200%）
   - 临时连接线预览

4. **PropertyPanel.vue** - 属性面板
   - **地图属性**（未选中节点时）：
     * 地图名称、描述
     * 背景图片路径
     * 地图类别（城市/野外）
     * 背景音乐（环境/战斗）
     * 默认节点（野外地图）
   - **战斗节点属性**：
     * 基本信息（ID、标签、坐标）
     * 怪物生成配置（最小/最大数量、刷新间隔）
     * 怪物列表（ID + 权重）
     * NPC 列表
     * 连接关系
   - **传送门属性**：
     * 目标地图和节点选择
     * 标签和描述
   - **城市地点属性**：
     * 名称、描述
     * 路由配置（前端路由跳转）

**状态管理 (Pinia):**

- **maps.ts** - 地图状态
  - 加载/保存地图数据
  - 更新当前编辑地图
  - 撤销/重做接口

- **history.ts** - 历史记录
  - 操作历史栈（最多 50 条）
  - 撤销/重做逻辑
  - 保存点标记（保存后清除之前的撤销历史）
  - 状态深拷贝（避免引用问题）

## 渲染实现细节

### CSS 样式层级

```html
<div class="editor-map-canvas">
  <!-- Layer 1: 背景图片 -->
  <img class="map-image" />
  
  <!-- Layer 2: 网格（可选） -->
  <svg class="grid-overlay" />
  
  <!-- Layer 3: SVG 连接线 -->
  <svg class="node-graph">
    <line class="graph-edge" />
  </svg>
  
  <!-- Layer 4: 节点标记 -->
  <button class="node-marker node-type-battle" />
  <button class="node-marker node-type-portal" />
</div>
```

### 节点样式（游戏一致）

```css
/* 战斗节点 - 红色 */
.node-type-battle {
  color: rgba(239, 68, 68, 0.9);
  border-color: rgba(239, 68, 68, 0.6);
}

/* 传送门 - 蓝色虚线 */
.node-type-portal {
  color: rgba(59, 130, 246, 0.9);
  border-color: rgba(59, 130, 246, 0.6);
  border-style: dashed;
}

/* 城市地点 - 青色 */
.map-location {
  border-color: rgba(34, 211, 238, 0.5);
}
```

### 坐标系统

- 使用百分比坐标 (0-100)
- 与 JSON 数据完全一致
- 支持精确输入和拖拽调整
- 可选网格吸附（5% 步进）

## 使用方法

### 启动服务

```bash
# 后端
cd editor/backend
.venv/bin/python main.py

# 前端
cd editor/frontend
npm run dev
```

### 编辑流程

1. **选择地图**
   - 从左侧列表选择要编辑的地图
   - 地图自动加载到画布

2. **编辑模式切换**
   - **选择**: 点击节点查看/编辑属性
   - **移动**: 拖拽节点改变位置
   - **连接**: 点击两个节点建立连接（会显示临时连接线）
   - **添加战斗节点** (野外地图): 在画布上点击位置创建战斗点
   - **添加传送门** (野外地图): 创建跨地图传送点
   - **添加地点** (城市地图): 创建可交互位置

3. **节点操作**
   - 点击选中节点，右侧面板显示属性
   - 拖拽移动节点位置（自动更新坐标）
   - 在属性面板编辑详细信息
   - 配置怪物生成列表（战斗节点）
   - 设置传送门目标（传送门节点）
   - 按 `Delete` 删除选中节点

4. **连接管理**
   - 连接模式下，点击起始节点，再点击目标节点
   - 连接线自动绘制（SVG）
   - 可在属性面板查看和删除连接
   - 删除节点时自动删除相关连接

5. **撤销/重做**
   - 工具栏显示撤销/重做按钮状态
   - `Ctrl+Z` 撤销上一步操作
   - `Ctrl+Y` 或 `Ctrl+Shift+Z` 重做
   - 保存后会创建保存点（无法撤销到保存前）
   - 未保存状态显示警告图标

6. **保存更改**
   - 点击工具栏的"💾 保存"按钮
   - 数据自动写入 `../../src/data/map-metadata.json`
   - 保存成功后显示"已保存"状态
   - 创建新的保存点（清除之前的撤销历史）

### 工具栏功能

- **编辑模式按钮**: 选择、移动、连接、添加节点
- **撤销/重做按钮**: 显示可用状态，支持快捷键
- **缩放控制**: 50%-200% 调节画布大小
- **网格选项**: 显示网格、启用吸附（5% 步进）
- **保存按钮**: 保存地图数据
- **保存状态指示器**: 已保存/未保存

### 快捷键
- `Ctrl+Z`: 撤销上一步操作
- `Ctrl+Y` / `Ctrl+Shift+Z`: 重做
- `Delete`: 删除选中的节点或地点
- `Escape`: 取消连接模式，返回选择模式
- 拖拽节点时开启"吸附"可自动对齐网格

## 数据格式

### 战斗节点示例

```json
{
  "id": "fringe-01",
  "label": "青苔原01",
  "type": "battle",
  "position": { "x": 26, "y": 60 },
  "connections": ["fringe-city-gate", "fringe-04"],
  "spawn": {
    "min": 2,
    "max": 3,
    "intervalSeconds": 900,
    "respawnSeconds": 60,
    "monsters": [
      { "id": "m-slime", "weight": 2 },
      { "id": "m-wolf", "weight": 1 }
    ]
  }
}
```

### 传送门节点示例

```json
{
  "id": "fringe-city-gate",
  "label": "翡冷翠",
  "type": "portal",
  "position": { "x": 6, "y": 64 },
  "connections": ["fringe-01"],
  "destination": {
    "mapId": "florence"
  }
}
```

## 技术栈

- **后端**: Python 3.12, FastAPI, Pydantic
- **前端**: Vue 3, TypeScript, Element Plus, Pinia
- **样式**: 100% 复用游戏 `MapView.vue` 的 CSS

## 设计亮点

1. ✅ **所见即所得** - 编辑器渲染效果与游戏完全一致
2. ✅ **百分比坐标** - 无需转换，直接对应 JSON 数据
3. ✅ **SVG 连接线** - 平滑的矢量图形，支持交互和选择
4. ✅ **网格辅助** - 可视化网格帮助对齐
5. ✅ **类型安全** - TypeScript 保证数据结构正确
6. ✅ **怪物关联** - 从 `monster-blueprints.json` 读取怪物列表
7. ✅ **撤销/重做** - 完整的历史记录栈（最多 50 条）
8. ✅ **保存状态** - 实时显示已保存/未保存状态
9. ✅ **快捷键支持** - Ctrl+Z/Y 等标准快捷键
10. ✅ **自动 ID 生成** - 创建节点时自动分配递增 ID

## 扩展功能

已实现：
- ✅ 撤销/重做功能（Ctrl+Z / Ctrl+Y）
- ✅ 保存状态追踪
- ✅ 快捷键支持
- ✅ 网格吸附
- ✅ 缩放控制

待扩展功能：
- [ ] 批量操作（框选多个节点）
- [ ] 地图创建向导
- [ ] 背景图片上传
- [ ] 自动布局算法
- [ ] 路径查找可视化
- [ ] 导入/导出单个地图
- [ ] 节点复制/粘贴
- [ ] 连接线样式自定义
